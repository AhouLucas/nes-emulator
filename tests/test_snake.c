#include "../headers/common.h"
#include "../headers/cpu.h"
#include "raylib.h"

#define SCREEN_WIDTH 800
#define SCREEN_HEIGHT 800
#define NCASES 32
#define CASE_SIZE SCREEN_WIDTH / NCASES

uint8_t game_code[] = {
    0x20, 0x06, 0x06, 0x20, 0x38, 0x06, 0x20, 0x0d, 0x06, 0x20, 0x2a, 0x06, 0x60, 0xa9, 0x02, 0x85,
    0x02, 0xa9, 0x04, 0x85, 0x03, 0xa9, 0x11, 0x85, 0x10, 0xa9, 0x10, 0x85, 0x12, 0xa9, 0x0f, 0x85,
    0x14, 0xa9, 0x04, 0x85, 0x11, 0x85, 0x13, 0x85, 0x15, 0x60, 0xa5, 0xfe, 0x85, 0x00, 0xa5, 0xfe,
    0x29, 0x03, 0x18, 0x69, 0x02, 0x85, 0x01, 0x60, 0x20, 0x4d, 0x06, 0x20, 0x8d, 0x06, 0x20, 0xc3,
    0x06, 0x20, 0x19, 0x07, 0x20, 0x20, 0x07, 0x20, 0x2d, 0x07, 0x4c, 0x38, 0x06, 0xa5, 0xff, 0xc9,
    0x77, 0xf0, 0x0d, 0xc9, 0x64, 0xf0, 0x14, 0xc9, 0x73, 0xf0, 0x1b, 0xc9, 0x61, 0xf0, 0x22, 0x60,
    0xa9, 0x04, 0x24, 0x02, 0xd0, 0x26, 0xa9, 0x01, 0x85, 0x02, 0x60, 0xa9, 0x08, 0x24, 0x02, 0xd0,
    0x1b, 0xa9, 0x02, 0x85, 0x02, 0x60, 0xa9, 0x01, 0x24, 0x02, 0xd0, 0x10, 0xa9, 0x04, 0x85, 0x02,
    0x60, 0xa9, 0x02, 0x24, 0x02, 0xd0, 0x05, 0xa9, 0x08, 0x85, 0x02, 0x60, 0x60, 0x20, 0x94, 0x06,
    0x20, 0xa8, 0x06, 0x60, 0xa5, 0x00, 0xc5, 0x10, 0xd0, 0x0d, 0xa5, 0x01, 0xc5, 0x11, 0xd0, 0x07,
    0xe6, 0x03, 0xe6, 0x03, 0x20, 0x2a, 0x06, 0x60, 0xa2, 0x02, 0xb5, 0x10, 0xc5, 0x10, 0xd0, 0x06,
    0xb5, 0x11, 0xc5, 0x11, 0xf0, 0x09, 0xe8, 0xe8, 0xe4, 0x03, 0xf0, 0x06, 0x4c, 0xaa, 0x06, 0x4c,
    0x35, 0x07, 0x60, 0xa6, 0x03, 0xca, 0x8a, 0xb5, 0x10, 0x95, 0x12, 0xca, 0x10, 0xf9, 0xa5, 0x02,
    0x4a, 0xb0, 0x09, 0x4a, 0xb0, 0x19, 0x4a, 0xb0, 0x1f, 0x4a, 0xb0, 0x2f, 0xa5, 0x10, 0x38, 0xe9,
    0x20, 0x85, 0x10, 0x90, 0x01, 0x60, 0xc6, 0x11, 0xa9, 0x01, 0xc5, 0x11, 0xf0, 0x28, 0x60, 0xe6,
    0x10, 0xa9, 0x1f, 0x24, 0x10, 0xf0, 0x1f, 0x60, 0xa5, 0x10, 0x18, 0x69, 0x20, 0x85, 0x10, 0xb0,
    0x01, 0x60, 0xe6, 0x11, 0xa9, 0x06, 0xc5, 0x11, 0xf0, 0x0c, 0x60, 0xc6, 0x10, 0xa5, 0x10, 0x29,
    0x1f, 0xc9, 0x1f, 0xf0, 0x01, 0x60, 0x4c, 0x35, 0x07, 0xa0, 0x00, 0xa5, 0xfe, 0x91, 0x00, 0x60,
    0xa6, 0x03, 0xa9, 0x00, 0x81, 0x10, 0xa2, 0x00, 0xa9, 0x01, 0x81, 0x10, 0x60, 0xa2, 0x00, 0xea,
    0xea, 0xca, 0xd0, 0xfb, 0x60
};

Color* screen;


void handle_user_input(CPU_t* cpu) {
    if (IsKeyDown(KEY_UP)) {
        CPU_mem_write_u8(cpu, 0xFF, 0x77);
    }
    else if (IsKeyDown(KEY_DOWN)) {
        CPU_mem_write_u8(cpu, 0xFF, 0x73);
    }
    else if (IsKeyDown(KEY_LEFT)) {
        CPU_mem_write_u8(cpu, 0xFF, 0x61);
    }
    else if (IsKeyDown(KEY_RIGHT)) {
        CPU_mem_write_u8(cpu, 0xFF, 0x64);
    }
}


Color get_color(uint8_t value) {
    switch (value) {
    case 0x00:
        return BLACK;
    case 0x01:
        return WHITE;
    case 0x02:
    case 0x09:
        return GRAY;
    case 0x03:
    case 0x10:
        return RED;
    case 4:
    case 11:
        return GREEN;
    case 5:
    case 12:
        return BLUE;
    case 6:
    case 13:
        return MAGENTA;
    case 7:
    case 14:
        return YELLOW;
    default:
        return WHITE;
    }
}

bool color_equals(Color c1, Color c2) {
    return c1.r == c2.r && c1.g == c2.g && c1.b == c2.b && c1.a == c2.a;
}

void draw_screen(Color* screen) {
    BeginDrawing();
    ClearBackground(BLACK);
    for (int i = 0; i < NCASES; i++) {
        for (int j = 0; j < NCASES; j++) {
            DrawRectangle(i*CASE_SIZE, j*CASE_SIZE, CASE_SIZE, CASE_SIZE, screen[i*NCASES+j]);
        }
    }
    EndDrawing();
}

void callback(CPU_t* cpu) {
    handle_user_input(cpu);
    CPU_mem_write_u8(cpu, 0xFE, (rand() + 1) % 0xFF);

    draw_screen(screen);

    usleep(10 * 1000);
}

// The load function is a bit different from the CPU_load function in the CPU module
// This function loads the game from 0x0600
void load_game(CPU_t* cpu, uint8_t* program, size_t program_size) {
    memcpy(cpu->memory+0x0600, program, program_size);
    CPU_mem_write_u16(cpu, 0xFFFC, 0x0600);
}

void run_snake(CPU_t* cpu) {
    while (!WindowShouldClose()) {

        printf("PC: %x\n", cpu->pc);
        uint8_t opcode = CPU_mem_read_u8(cpu, cpu->pc);
        cpu->pc++;
        uint16_t pc_state = cpu->pc;

        if (opcode == 0x00) {
            printf("Game over\n");
            return;
        }

        OpcodeEntry_t entry = opcode_table[opcode];

        switch (entry.type) {
        case INSTRUCTION_TYPE_VOID:
            entry.instruction.void_instruction(cpu, entry.mode);
            break;
        case INSTRUCTION_TYPE_U8:
            entry.instruction.u8_instruction(cpu, entry.mode);
            break;
        default:
            printf("Unknown instruction type\n");
            exit(EXIT_FAILURE);
            break;
        }

        if (pc_state == cpu->pc) {
            cpu->pc += (uint16_t) entry.len - 1;
        }

        callback(cpu);
    }

    CloseWindow();
}


int main(int argc, char const *argv[]) {
    
    CPU_t* cpu = CPU_init();
    load_game(cpu, game_code, sizeof(game_code));
    CPU_reset(cpu);

    screen = (Color*) malloc(NCASES*NCASES*sizeof(Color));
    for (int i = 0; i < NCASES*NCASES; i++) {
        screen[i] = BLACK;
    }

    InitWindow(SCREEN_WIDTH, SCREEN_HEIGHT, "Inshallah Ã§a marche");

    run_snake(cpu);

    CPU_free(cpu);

    return 0;
}
